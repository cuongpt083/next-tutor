# Conventions for API code generation

projectName: cuongpt-next-tutor
basePackage: com.cuongpt.nexttutor

## I. Outline

- **Mục tiêu chính**: Việc generate code cho API theo đặc tả API và tuân theo các quy tắc tổ chức code trong dự án.
- **Mục tiêu phụ**: Tuân theo các quy tắc tổ chức code trong dự án.

## II. Quy tắc tổ chức code

- **Cấu trúc thư mục**: thư mục chứa file của Project API nằm tại vị trí `{projectName}`
  - `src/main/java/{basePackage}/api`: chứa các class, interface định nghĩa các API
  - `src/main/java/{basePackage}/controller`: chứa các class, interface định nghĩa các controller
  - `src/main/java/{basePackage}/model`: chứa các class, interface định nghĩa các model, bao gồm các loại con sau:
    - `src/main/java/{basePackage}/model/dto/request`: chứa các class, interface định nghĩa các model dto request
    - `src/main/java/{basePackage}/model/dto/response`: chứa các class, interface định nghĩa các model dto response
    - `src/main/java/{basePackage}/model/dto`: chứa các class, interface định nghĩa các model dto
    - `src/main/java/{basePackage}/model/entity`: chứa các class, interface định nghĩa các model entity. Các model entity được định nghĩa theo DDL trong hệ thống Next Tutor ở file `docs/master-data/db-ddl.sql`
  - `src/main/java/{basePackage}/repository`: chứa các class, interface định nghĩa các repository
  - `src/main/java/{basePackage}/service`: chứa các class, interface định nghĩa các service
  - `src/main/java/{basePackage}/utility`: chứa các class, interface định nghĩa các utilities
  - `src/main/java/{basePackage}/common`: chứa các class, interface dùng chung cho các API
  - `src/main/java/{basePackage}/configuration`: chứa các class, interface định nghĩa các configuration
  - `src/main/resources/api`: chứa các file đặc tả API, trong đó các file đặc tả API có tên file theo định dạng `{apiName}.api.spec.yaml`
  - `src/main/resources/liquibase`: chứa các file đặc tả Liquibase changeset, sql, properties.
  - `src/main/resources/logback.xml`: chứa các file đặc tả logback.
  - `src/main/resources/application-{profile}.yaml`: chứa các file đặc tả application.

- **Quy tắc tổ chức source code đảm bảo tính Modular và Maintainable ở cấp độ Method**: Các phương thức công khai (public methods), đặc biệt là các phương thức xử lý nghiệp vụ chính trong Service Layer hoặc Controller, phải tập trung vào việc mô tả luồng công việc (workflow) ở cấp độ cao. Các bước xử lý chi tiết, cụ thể hơn phải được ủy quyền (delegate) cho các phương thức riêng tư (private methods) trong cùng lớp hoặc cho các service/component khác.
  - **Các lỗi cần tránh**:
    - Outline-MonolithicMethod: LLM tạo ra một phương thức public khổng lồ chứa tất cả các bước từ validation, logic nghiệp vụ đến lưu trữ dữ liệu, khiến nó khó đọc, khó kiểm thử và khó bảo trì.
    - Aim-UnclearWorkflow: Khi đọc code, rất khó để nắm bắt được các bước chính của một nghiệp vụ vì chúng bị chôn vùi trong hàng trăm dòng code chi tiết.
    - Aim-LowTestability: Khó viết unit test cho từng phần nhỏ của logic vì tất cả đều nằm trong một phương thức lớn.
  - **Ví dụ mẫu code đúng**:

    ```java
      /**
       * Processes a new customer order by validating items, calculating total,
       * persisting the order, and sending a confirmation.
       * @param orderRequest The request containing order details.
       * @return The processed Order object.
       * @throws InvalidOrderException If order items are invalid.
       * @throws PaymentProcessingException If payment fails.
       */
      public Order processNewOrder(OrderRequest orderRequest) {
          validateOrderItems(orderRequest.getItems()); // Delegate to private method
          Customer customer = customerService.findCustomer(orderRequest.getCustomerId()); // Delegate to another service
          double totalPrice = calculateTotalPrice(orderRequest.getItems()); // Delegate to private method
          PaymentResult paymentResult = paymentGateway.processPayment(customer, totalPrice); // Delegate to external component

          if (!paymentResult.isSuccess()) {
              throw new PaymentProcessingException("Payment failed for order: " + orderRequest.getOrderId());
          }

          Order newOrder = createOrderEntity(orderRequest, customer, totalPrice); // Delegate to private method
          orderRepository.save(newOrder); // Delegate to repository

          notificationService.sendOrderConfirmation(newOrder); // Delegate to another service
          return newOrder;
      }
      // Private helper methods for detailed steps
      private void validateOrderItems(List<OrderItem> items) { /* ... detailed validation logic ... */ }
      private double calculateTotalPrice(List<OrderItem> items) { /* ... complex price calculation ... */ }
      private Order createOrderEntity(OrderRequest request, Customer customer, double total) { /* ... mapping and entity creation ... */ }
    ```

  - Ví dụ mẫu code sai:

    ```java
      public Order processNewOrder(OrderRequest orderRequest) {
      // 100 lines of validation logic
      // 50 lines of customer lookup and error handling
      // 80 lines of price calculation with discounts
      // 120 lines of payment gateway integration and retry logic
      // 70 lines of order entity creation and mapping
      // 40 lines of database persistence
      // 60 lines of notification sending and logging
      // ... total 500+ lines in one method ...
      }
    ```

- **Quy tắc tạo tài liệu Javadoc toàn diện**: Tất cả các lớp (class), giao diện (interface), phương thức (method) và trường (field) công khai/bảo vệ (public/protected) phải có Javadoc đầy đủ, giải thích mục đích, cách sử dụng, tham số, giá trị trả về và các ngoại lệ có thể xảy ra. Sử dụng các tag Javadoc tiêu chuẩn (@param, @return, @throws, @see, @since, @author).
  - **Các Javadoc style cần tránh**:
    - Style-MissingJavadoc: LLM không tạo Javadoc, khiến code khó hiểu cho người khác và cho chính bạn sau này.
    - Style-IncompleteJavadoc: Javadoc chỉ có một dòng chung chung, không giải thích chi tiết các tham số hay giá trị trả về.
    - Aim-UnclearPurpose: Javadoc không giải thích tại sao một phương thức lại tồn tại hoặc mục đích của một lớp.
    - Style-RedundantJavadoc: Javadoc có thể được lược bỏ hoặc đơn giản hóa.
  - **Ví dụ mẫu Javadoc đúng**:

    ```java

        /**
         * Service responsible for handling all payment-related business logic.
        * This includes processing payments, managing transactions, and handling refunds.
        * Implements {@link com.yourbank.payments.api.PaymentProcessor} for external integration.
        * @author YourName
        * @since 1.0.0
        */
        @Service
        public class PaymentService {

            private final PaymentRepository paymentRepository;

            /**
            * Constructs a new PaymentService with the given repository.
            * @param paymentRepository The repository for payment data access.
            */
            public PaymentService(PaymentRepository paymentRepository) {
                this.paymentRepository = paymentRepository;
            }

            /**
            * Processes a new payment request.
            * Validates the request, deducts funds, and records the transaction.
            * @param request The {@link PaymentRequest} containing payment details.
            * @return A {@link PaymentResponse} indicating the status of the payment.
            * @throws InvalidPaymentException If the payment details are invalid.
            * @throws InsufficientFundsException If the account has insufficient funds.
            * @see #refundPayment(String)
            */
            public PaymentResponse processPayment(PaymentRequest request) throws InvalidPaymentException, InsufficientFundsException {
                // ... implementation
            }
        }
        
    ```

    - Sử dụng các tag Javadoc tiêu chuẩn (@param, @return, @throws, @see, @since, @author).
