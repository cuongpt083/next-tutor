# Detailed Design Document - Quiz Module

## 1. Kiến trúc tổng thể (Architecture)

### 1.1. Sơ đồ kiến trúc hệ thống (System Architecture Diagram)
Tham khảo sơ đồ kiến trúc hệ thống trong tài liệu tổng thể [1.detailed_design_document.md](1.detailed_design_document.md).

### 1.2. Mô tả các thành phần

* **Frontend (Angular 17)**: Ứng dụng Single Page Application (SPA) chịu trách nhiệm hiển thị giao diện người dùng, xử lý tương tác (ghi âm, kéo thả), và giao tiếp với Backend qua REST API.

* **Backend API (Spring Boot 21)**: Đóng vai trò là Backend API, xử lý logic nghiệp vụ, xác thực, và điều phối các yêu cầu tới Database và AI Services.

* **Backend BFF (Spring Boot 21)**: Đóng vai trò là BFF đồng thời là API Gateway (Backend For Frontend), xử lý logic xác thực, và điều phối các yêu cầu tới Backend API. BFF chịu trách nhiệm chuyển đổi các yêu cầu từ Frontend thành các yêu cầu hợp lệ tới Backend API. Frontend chỉ cần giao tiếp với BFF. Frontend không lưu trữ thông tin xác thực người dùng như JWT Token, mà chỉ lưu trữ Cookie Session ID. BFF sử dụng Cookie Session ID mà Frontend cung cấp để xác thực người dùng thông qua việc ánh xạ Cookie Session ID tới JWT Token mà nó duy trì trên local memory cache. Sau khi xác thực người dùng thành công, BFF sẽ chuyển đổi Cookie Session ID thành JWT Token và lưu trữ JWT Token trong local memory cache. BFF sẽ sử dụng JWT Token để xác thực người dùng thông qua các yêu cầu tới Backend API.

* **Database (PostgreSQL 15)**: Lưu trữ thông tin người dùng, cấu hình gia sư, lịch sử phiên học, kho câu hỏi kèm đáp án cho các bài quiz, kho game role-play, và dữ liệu tiến độ.

* **AI Service Adapter**: Module trong Backend chịu trách nhiệm giao tiếp với các mô hình LLM và TTS, quản lý Context, và thực hiện Rotation API Key. Trong phiên bản hiện tại của phần mềm, AI Service Adapter sẽ sử dụng các API của OpenAI, các phiên bản sau này sẽ sử dụng thêm các API của Gemini và Grok, việc thiết kế AI Service Adapter sẽ được thực hiện theo hướng mở rộng để dễ dàng thêm các API mới.


## 2. Thiết kế chi tiết API Backend (API Design) cho module Quiz

### 2.1. Get Quiz

* **Endpoint**: `GET /api/v1/quizzes`
* **Request Params**: `level=A2&skill=READING&topic=SCIENCE`
* **Response**:

    ```json
    {
      "quizId": "uuid",
      "questions": [
        {
          "id": "q1",
          "type": "MULTIPLE_CHOICE",
          "content": "The sun rises in the...",
          "options": ["West", "East", "North", "South"],
          "audioUrl": null
        }
      ]
    }
    ```

* **Logic xử lý**:
    1. Truy vấn DB để tìm Quiz phù hợp với các tiêu chí được truyền vào từ Request Params (ví dụ: level, skill, topic)
    2. Nếu tìm thấy Quiz phù hợp, trả về Quiz đó
    3. Nếu không tìm thấy Quiz phù hợp, thực hiện các bước sau:
        1. Sử dụng tiêu chí được truyền vào từ Request Params để tạo Context cho AI Service Adapter. Gọi API của AI Service Adapter để tạo Quiz mới.
        2. Lưu Quiz mới vào DB
        3. Trả về Quiz mới
        
* **Error Handling**:
    1. Nếu có lỗi xảy ra trong quá trình giao tiếp với AI Service Adapter, trả về lỗi 500
    2. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    3. Nếu có lỗi xảy ra trong quá trình lưu Quiz vào DB, trả về lỗi 500
    4. Nếu có lỗi xảy ra trong quá trình trả về Quiz, trả về lỗi 500



