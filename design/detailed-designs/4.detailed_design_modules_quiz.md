# Detailed Design Document - Quiz Module

## 1. Kiến trúc tổng thể (Architecture)

### 1.1. Sơ đồ kiến trúc hệ thống (System Architecture Diagram)
Tham khảo sơ đồ kiến trúc hệ thống trong tài liệu tổng thể [1.detailed_design_document.md](1.detailed_design_document.md).

### 1.2. Mô tả các thành phần

* **Frontend (Angular 17)**: Ứng dụng Single Page Application (SPA) chịu trách nhiệm hiển thị giao diện người dùng, xử lý tương tác (ghi âm, kéo thả), và giao tiếp với Backend qua REST API.

* **Backend API (Spring Boot 21)**: Đóng vai trò là Backend API, xử lý logic nghiệp vụ, xác thực, và điều phối các yêu cầu tới Database và AI Services.

* **Backend BFF (Spring Boot 21)**: Đóng vai trò là BFF đồng thời là API Gateway (Backend For Frontend), xử lý logic xác thực, và điều phối các yêu cầu tới Backend API. BFF chịu trách nhiệm chuyển đổi các yêu cầu từ Frontend thành các yêu cầu hợp lệ tới Backend API. Frontend chỉ cần giao tiếp với BFF. Frontend không lưu trữ thông tin xác thực người dùng như JWT Token, mà chỉ lưu trữ Cookie Session ID. BFF sử dụng Cookie Session ID mà Frontend cung cấp để xác thực người dùng thông qua việc ánh xạ Cookie Session ID tới JWT Token mà nó duy trì trên local memory cache. Sau khi xác thực người dùng thành công, BFF sẽ chuyển đổi Cookie Session ID thành JWT Token và lưu trữ JWT Token trong local memory cache. BFF sẽ sử dụng JWT Token để xác thực người dùng thông qua các yêu cầu tới Backend API.

* **Database (PostgreSQL 15)**: Lưu trữ thông tin người dùng, cấu hình gia sư, lịch sử phiên học, kho câu hỏi kèm đáp án cho các bài quiz, kho game role-play, và dữ liệu tiến độ.

* **AI Service Adapter**: Module trong Backend chịu trách nhiệm giao tiếp với các mô hình LLM và TTS, quản lý Context, và thực hiện Rotation API Key. Trong phiên bản hiện tại của phần mềm, AI Service Adapter sẽ sử dụng các API của OpenAI, các phiên bản sau này sẽ sử dụng thêm các API của Gemini và Grok, việc thiết kế AI Service Adapter sẽ được thực hiện theo hướng mở rộng để dễ dàng thêm các API mới.


## 2. Thiết kế chi tiết API Backend (API Design) cho module Quiz

### 2.1. Get Quiz

* **Endpoint**: `GET /api/v1/quizzes`
* **Request Params**: `level=A2&skill=READING&topic=SCIENCE`
* **Response**:

    ```json
    {
      "quizId": "uuid",
      "isActive": true,
      "questions": [
        {
          "id": "q1",
          "type": "MULTIPLE_CHOICE",
          "content": "The sun rises in the...",
          "options": ["West", "East", "North", "South"],
          "solution": "East",
          "explanation": "The sun rises in the east because the Earth rotates from west to east.",
          "hint": "The Earth rotates from west to east.",
          "audioUrl": null
        }
      ]
    }
    ```

* **Logic xử lý**:
    1. Truy vấn DB để tìm Quiz phù hợp với các tiêu chí được truyền vào từ Request Params (ví dụ: level, skill, topic) và trạng thái `isActive` là `true`.
    2. Nếu tìm thấy Quiz phù hợp, trả về Quiz đó
    3. Nếu không tìm thấy Quiz phù hợp, thực hiện các bước sau:
        1. Sử dụng tiêu chí được truyền vào từ Request Params để tạo Context cho AI Service Adapter thông qua util function `ContextManager.createContext`, lưu ý thiết lập `messagePrompt` cho yêu cầu tới AI Service Adapter bao gồm các thông tin như level, skill, topic, và số lượng câu hỏi. Gọi API của AI Service Adapter để tạo Quiz mới.
        2. Lưu Quiz mới vào DB bảng `quizzes` với `isActive` là `true`.
        3. Trả về Quiz mới. Trong nội dung của Quiz trả về, trường `solution` sẽ được mã hóa theo thuật toán RC4 với key được lấy từ `application.properties` để đảm bảo người học không thể gian lận bằng cách xem trước đáp án.
        
* **Error Handling**:
    1. Nếu có lỗi xảy ra trong quá trình giao tiếp với AI Service Adapter, trả về lỗi 500
    2. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    3. Nếu có lỗi xảy ra trong quá trình lưu Quiz vào DB, trả về lỗi 500
    4. Nếu có lỗi xảy ra trong quá trình trả về Quiz, trả về lỗi 500



### 2.2. Get Quiz by ID

* **Endpoint**: `GET /api/v1/quizzes/{quizId}`
* **Request Params**: `quizId`
* **Response**:

    ```json
    {
      "quizId": "uuid",
      "isActive": true,
      "questions": [
        {
          "id": "q1",
          "type": "MULTIPLE_CHOICE",
          "content": "The sun rises in the...",
          "options": ["West", "East", "North", "South"],
          "solution": "East",
          "explanation": "The sun rises in the east because the Earth rotates from west to east.",
          "hint": "The Earth rotates from west to east.",
          "audioUrl": null
        }
      ]
    }
    ```

* **Logic xử lý**:
    1. Truy vấn DB để tìm Quiz phù hợp với `quizId`
    2. Nếu tìm thấy Quiz phù hợp, trả về Quiz đó
    3. Nếu không tìm thấy Quiz phù hợp, trả về lỗi 404
    4. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    5. Nếu có lỗi xảy ra trong quá trình trả về Quiz, trả về lỗi 500

* **Error Handling**:
    1. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    2. Nếu có lỗi xảy ra trong quá trình trả về Quiz, trả về lỗi 500

### 2.3. Update Quiz

* **Endpoint**: `PUT /api/v1/quizzes/{quizId}`
* **Request Params**: `quizId`
* **Request Body**:

    ```json
    {
      "quizId": "uuid",
      "isActive": true,
      "questions": [
        {
          "id": "q1",
          "type": "MULTIPLE_CHOICE",
          "content": "The sun rises in the...",
          "options": ["West", "East", "North", "South"],
          "solution": "East",
          "explanation": "The sun rises in the east because the Earth rotates from west to east.",
          "hint": "The Earth rotates from west to east.",
          "audioUrl": null
        }
      ]
    }
    ```

* **Logic xử lý**:
    1. Truy vấn DB để tìm Quiz phù hợp với `quizId`
    2. Nếu tìm thấy Quiz phù hợp, cập nhật Quiz đó
    3. Nếu không tìm thấy Quiz phù hợp, trả về lỗi 404
    4. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    5. Nếu có lỗi xảy ra trong quá trình cập nhật Quiz, trả về lỗi 500

* **Error Handling**:
    1. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    2. Nếu có lỗi xảy ra trong quá trình cập nhật Quiz, trả về lỗi 500

### 2.4. Submit Quiz Answer

* **Endpoint**: `POST /api/v1/quizzes/{quizId}/submit`
* **Request Params**: `quizId`
* **Request Body**:

    ```json
    {
      "answers": [
        { "questionId": "q1", "selectedOption": "East" }
      ]
    }
    ```

* **Response**:

    ```json
    {
      "score": 10,
      "totalQuestions": 10,
      "details": [
        {
          "questionId": "q1",
          "isCorrect": true,
          "explanation": "The sun always rises in the East due to Earth's rotation."
        }
      ]
    }
    ```

* **Logic xử lý**:
    1. Truy vấn DB để tìm Quiz phù hợp với `quizId`
    2. Nếu tìm thấy Quiz phù hợp thì thực hiện lần lượt các hành động sau:
      1. So sánh đáp án được gửi từ người dùng với đáp án trong Quiz.
      2. Tính toán điểm số dựa trên số lượng câu trả lời đúng. Điểm số sẽ được gán vào field `score` trong response. Gọi function `ProgressManager.updateProgress` để cập nhật thông tin vào bảng `user_progress`.
      3. Trả về kết quả so sánh, bao gồm điểm số và chi tiết về mỗi câu trả lời, bao gồm `questionId`, `isCorrect`, `explanation`.
    3. Nếu không tìm thấy Quiz phù hợp, trả về lỗi 404
    4. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    5. Nếu có lỗi xảy ra trong quá trình so sánh đáp án, trả về lỗi 500

* **Error Handling**:
    1. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    2. Nếu có lỗi xảy ra trong quá trình cập nhật Quiz, trả về lỗi 500
    3. Nếu có lỗi xảy ra trong quá trình so sánh đáp án, trả về lỗi 500

2.5. Delete Quiz

* **Endpoint**: `DELETE /api/v1/quizzes/{quizId}`
* **Request Params**: `quizId`
* **Response**:
    ```json
    {
      "quizId": "uuid",
      "message": "Quiz deleted successfully"
    }
    ```

* **Logic xử lý**:
    1. Truy vấn DB để tìm Quiz phù hợp với `quizId`
    2. Nếu tìm thấy Quiz phù hợp, xóa Quiz đó, cập nhật audit log và trả về response.
    3. Nếu không tìm thấy Quiz phù hợp, trả về lỗi 404
    4. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    5. Nếu có lỗi xảy ra trong quá trình xóa Quiz, trả về lỗi 500

* **Error Handling**:
    1. Nếu có lỗi xảy ra trong quá trình truy vấn DB, trả về lỗi 500
    2. Nếu có lỗi xảy ra trong quá trình xóa Quiz, trả về lỗi 500


## 2. Tài liệu tham khảo 

* [RC4](https://en.wikipedia.org/wiki/RC4)
* Detailed Design [link] `designs/detailed-designs/4.detailed_design_modules_quiz.md`
* OpenAPI Specification [link] `designs/detailed-designs/2.openapi-specs.md` 